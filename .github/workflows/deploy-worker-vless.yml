name: Deploy Worker (vless)

on:
  push:
    branches: [main]
    paths:
      - "workers/vless.entry.js"
      - "workers/破皮版workers.js"
      - "wrangler.vless.toml"
      - ".github/workflows/deploy-worker-vless.yml"
  workflow_dispatch:

concurrency:
  group: deploy-worker-vless
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || '7f416be9fa20a235cafa1a13ab01b80d' }}
          command: deploy --keep-vars --config wrangler.vless.toml

      - name: Resolve workers.dev subdomain
        id: workers_subdomain
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID || '7f416be9fa20a235cafa1a13ab01b80d' }}
        run: |
          set -euo pipefail
          resp="$(curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/subdomain")"
          subdomain="$(echo "$resp" | jq -r '.result.subdomain // empty')"
          if [ -z "$subdomain" ]; then
            echo "Failed to resolve workers.dev subdomain:" >&2
            echo "$resp" | jq . >&2
            exit 1
          fi
          echo "subdomain=$subdomain" >> "$GITHUB_OUTPUT"
          echo "workers.dev subdomain: $subdomain"

      - name: Smoke test (vless)
        env:
          WORKERS_SUBDOMAIN: ${{ steps.workers_subdomain.outputs.subdomain }}
        run: |
          set -euo pipefail
          ping_url="https://cfspider-v2.${WORKERS_SUBDOMAIN}.workers.dev/__ping"
          ping_ok=0
          ping_headers=""
          ping_body=""
          ping_code=""
          ping_exit=""

          for attempt in $(seq 1 8); do
            ping_headers="$(mktemp)"
            ping_body="$(mktemp)"

            set +e
            ping_code="$(curl -sS -D "$ping_headers" -o "$ping_body" -w "%{http_code}" --max-time 20 "$ping_url")"
            ping_exit=$?
            set -e

            ping_text="$(cat "$ping_body" 2>/dev/null || true)"
            if [ "$ping_exit" = "0" ] && [ "$ping_code" = "200" ] && [ "$ping_text" = "pong" ]; then
              ping_ok=1
              break
            fi

            echo "Ping attempt $attempt failed: code=$ping_code exit=$ping_exit body=$(echo \"$ping_text\" | head -c 120)"
            sleep 3
          done

          if [ "$ping_ok" != "1" ]; then
            echo "GET $ping_url -> $ping_code (curl_exit=$ping_exit)"
            echo "--- response headers ---"
            cat "$ping_headers" || true
            echo "--- response body (first 2000 bytes) ---"
            head -c 2000 "$ping_body" || true
            echo
            exit 1
          fi

          root_url="https://cfspider-v2.${WORKERS_SUBDOMAIN}.workers.dev/"
          root_ok=0
          root_headers=""
          root_body=""
          root_code=""
          root_exit=""

          for attempt in $(seq 1 8); do
            root_headers="$(mktemp)"
            root_body="$(mktemp)"

            set +e
            root_code="$(curl -sS -D "$root_headers" -o "$root_body" -w "%{http_code}" --max-time 20 "$root_url")"
            root_exit=$?
            set -e

            if [ "$root_exit" = "0" ] && [ "$root_code" = "200" ] && grep -q "Welcome to nginx!" "$root_body"; then
              root_ok=1
              break
            fi

            echo "Root attempt $attempt failed: code=$root_code exit=$root_exit"
            sleep 3
          done

          if [ "$root_ok" != "1" ]; then
            echo "GET $root_url -> $root_code (curl_exit=$root_exit)"
            echo "--- response headers ---"
            cat "$root_headers" || true
            echo "--- response body (first 2000 bytes) ---"
            head -c 2000 "$root_body" || true
            echo
            exit 1
          fi
